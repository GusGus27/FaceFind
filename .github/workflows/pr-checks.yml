name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check PR title
      run: |
        PR_TITLE="${{ github.event.pull_request.title }}"
        if [[ ! $PR_TITLE =~ ^(feat|fix|docs|style|refactor|test|chore|perf):.+ ]]; then
          echo "‚ùå PR title must follow conventional commits format"
          echo "Examples: feat: add new feature, fix: resolve bug, docs: update readme"
          exit 1
        fi
        echo "‚úÖ PR title is valid"

    - name: Check for merge conflicts
      run: |
        git fetch origin ${{ github.base_ref }}
        if git merge-tree $(git merge-base HEAD origin/${{ github.base_ref }}) HEAD origin/${{ github.base_ref }} | grep -q '<<<<<<<'; then
          echo "‚ùå Merge conflicts detected"
          exit 1
        fi
        echo "‚úÖ No merge conflicts"

    - name: Check file changes
      run: |
        echo "Files changed in this PR:"
        git diff --name-only origin/${{ github.base_ref }}...HEAD

    - name: Comment on PR
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = context.issue.number;
          const message = `
          ## ü§ñ Automated PR Check
          
          ‚úÖ PR validation passed!
          
          **Checks performed:**
          - ‚úÖ Title follows conventional commits
          - ‚úÖ No merge conflicts detected
          
          **Next steps:**
          - Wait for CI/CD pipeline to complete
          - Request review from team members
          - Address any feedback
          `;
          
          github.rest.issues.createComment({
            issue_number: prNumber,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: message
          });
